name: üöÄ Deploy to TimeWeb

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ö–∞—á–∞–µ–º –∫–æ–¥
      - name: üì• Download code
        uses: actions/checkout@v3
      
      # 2. –°–æ–±–∏—Ä–∞–µ–º Flutter
      - name: üéØ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: üî® Build Flutter Web
        run: |
          cd client
          flutter clean
          flutter pub get
          flutter build web --release
      
      # 3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è TimeWeb
      - name: üì¶ Prepare for TimeWeb
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          mkdir -p timeweb_deploy
          mkdir -p timeweb_deploy/backend
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (Flutter)
          cp -r client/build/web/* timeweb_deploy/
          
          # –ö–æ–ø–∏—Ä—É–µ–º –±—ç–∫–µ–Ω–¥ (FastAPI)
          cp -r backend/* timeweb_deploy/backend/
          
          # –ö–æ–ø–∏—Ä—É–µ–º .htaccess
          cp timeweb.htaccess timeweb_deploy/.htaccess
          
          # –í—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ timeweb_deploy:"
          ls -la timeweb_deploy/
      
      # 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ TimeWeb —á–µ—Ä–µ–∑ FTP
      - name: ‚¨ÜÔ∏è Upload to TimeWeb
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.TIMEWEB_FTP_SERVER }}
          username: ${{ secrets.TIMEWEB_FTP_USER }}
          password: ${{ secrets.TIMEWEB_FTP_PASSWORD }}
          local-dir: ./timeweb_deploy/
          server-dir: ./